# SystemD Unit File Encoding for Go

The `unitfile` package provides utilities for encoding and decoding (certain) Go
structs with semantics as similar to
[`encoding/json`](https://pkg.go.dev/encoding/json) as possible.

## Using

1. Install the module using `go get funkhouse.rs/unitfile`
2. Read the documentation at <https://pkg.go.dev/funkhouse.rs/unitfile>
3. Create a `struct` and `Marshal` and `Unmarshal` some Units for fun or profit

### Supported Types

Currently, the following builtin types are supported by this package as struct fields. Additionally, pointers to these types are also supported.

- `bool`
- `float32`, `float64`
- `int`, `int64`, `int32`, `int16`, `int8`
- `string`
- `[]string`

### Decoding

Decoding / Unmarshalling is performed using a lexer and parser generated by
ANTLR from a custom grammar. See [`UnitLexer.g4`](./UnitLexer.g4) and
[`UnitParser.g4`](./UnitParser.g4).

Though the goal is to be as similar to
[`encoding/json`](https://pkg.go.dev/encoding/json) as possible, the structure
of SystemD Unit files does not lend them to good generic encoding. I do not
recommend you use this library for that purpose. Instead, this library concerns
itself exclusively with at-most singly-nested structs. The usual structure of a
destination struct will contain the top-level Unit section options as struct
fields, and each subsequent section will be a struct.

For some well-known Unit and section types, see
[`wellknown.go`](./wellknown.go). For a simplified example, consider:

```go
type SimpleUnit struct {
  Description string
  Requires    []string
  Service struct {
    StartCommand string `unit:"ExecStart"`
    StopCommand  string `unit:"ExecStop"`
  }
}
```

Given this struct and [`ssh.service`](./testdata/ubuntu-22.04.1-ssh.service) (in
this case, the one distributed with Ubuntu 22.04.1), after unmarshalling

```go
var dest SimpleUnit
unitfile.Unmarshal(must(os.ReadFile("ssh.service")), &dest)
```

... `dest` will contain a value, like:

```go
SimpleUnit{
  Description: "OpenBSD Secure Shell server",
  Requires:    []string(nil),
  Service: struct {
    StartCommand string "unit:\"ExecStart\""
    StopCommand  string "unit:\"ExecStop\""
  }{
    StartCommand: "/usr/sbin/sshd -D $SSHD_OPTS",
    StopCommand:  "",
  },
}
```

## Encoding

The encoded / marshalled Unit file content is generated following the rules:

1. Exported `struct` fields will be treated as Unit options
2. Unexported fields will be ignored
3. Fields of anonymous member `struct`s will be treated as options of the parent
4. Non-anonymous `struct` members will be treated as sections
5. Non-anonymous `struct`s nested more than a single level deep will result in
   an error.
6. The name of the output field will be
   - the value of the `unit:` struct tag if it exists, or
   - the name of the struct field
7. All field names and values are sorted before output for determinism
8. Section names are sorted before output, _except_ for the top-level section,
 which stays at the top
9. `[]string` fields are output in the repeated `key=value` format

Continuing the example from above, after re-marshalling `dest`

```go
data = must(unitfile.Marshal(&dest))
```

... `data` will contain a generated Unit file, like:

```ini
[Unit]
Description=OpenBSD Secure Shell server
[Service]
ExecStart=/usr/sbin/sshd -D $SSHD_OPTS
```

## Developing

Feature Requests are more likely to be acknowledged if phrased in the form of a
Pull Request.

The details of the parser are hidden in `funkhouse.rs/unitfile/internal/parser`.
See the [documentation in that package](./internal/parser/README.md) for details
on how ANTLR grammar changes should be handled.
